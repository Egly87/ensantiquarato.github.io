<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Admin - Gestione Prodotti">
  <meta name="robots" content="noindex,nofollow">
  <title>Admin - Gestione Prodotti</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .admin-section {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #e0e0e0;
      font-weight: 500;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 4px;
      color: #e0e0e0;
      font-family: inherit;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    .btn-primary {
      background: #d4af37;
      color: #000;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: #e0c158;
      transform: translateY(-2px);
    }
    .btn-danger {
      background: #dc3545;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .product-card {
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      position: relative;
    }
    .product-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .product-card h3 {
      margin: 10px 0 5px 0;
      color: #d4af37;
    }
    .product-card p {
      margin: 5px 0;
      font-size: 0.9em;
      color: #999;
    }
    .product-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .btn-edit, .btn-delete {
      flex: 1;
      padding: 8px;
      text-align: center;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }
    .btn-edit {
      background: #0066cc;
      color: #fff;
    }
    .btn-delete {
      background: #dc3545;
      color: #fff;
    }
    .btn-ad {
      background: #1f7a3d;
      color: #fff;
      flex: 1;
      padding: 8px;
      text-align: center;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }
    .btn-online {
      background: #b8860b;
      color: #fff;
      flex: 1;
      padding: 8px;
      text-align: center;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }
    .alert {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .publish-panel {
      border: 1px solid #444;
      background: #171717;
    }
    .publish-panel p,
    .publish-panel li {
      color: #bbb;
    }
    .publish-panel ul {
      margin: 10px 0 15px 22px;
    }
    .publish-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .btn-secondary {
      background: #4a4a4a;
      color: #fff;
      padding: 10px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .file-inline {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
	    .token-input {
	      width: 100%;
	      min-width: 0;
	    }
	    .auth-status {
	      width: 100%;
	      justify-content: space-between;
	      border: 1px solid #5b4a1d;
	      background: #15120a;
	      border-radius: 6px;
	      padding: 10px;
	    }
	    .auth-status-label {
	      color: #e3c678;
	      font-weight: 600;
	    }
	    .config-grid {
	      display: grid;
	      grid-template-columns: 1fr;
	      gap: 10px;
      margin-top: 10px;
    }
    @media (min-width: 900px) {
      .config-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .config-grid .form-group {
      margin-bottom: 0;
    }
    .helper-note {
      font-size: 0.9em;
      color: #bdbdbd;
      margin-top: 8px;
    }
    .draft-box {
      width: 100%;
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .upload-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .upload-preview img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #333;
      background: #0f0f0f;
    }
    .status-note {
      font-size: 0.9em;
      color: #a9a9a9;
      margin-top: 8px;
    }
    .simple-flow {
      border: 1px solid #5b4a1d;
      background: #15120a;
      border-radius: 8px;
      padding: 14px;
      margin: 12px 0 0;
    }
    .simple-flow h3 {
      margin: 0 0 8px;
      color: #f3d37c;
      font-size: 1rem;
    }
    .simple-flow ol {
      margin: 0;
      padding-left: 18px;
      color: #d9d9d9;
    }
    .simple-flow li {
      margin: 6px 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-brand">
          <img src="assets/brand/logo.svg" alt="ENS Vintage" class="logo" loading="lazy" width="40" height="40" decoding="async">
          <span>ENS Vintage - Admin Annunci</span>
        </a>
        <nav class="navbar-menu">
          <a href="index.html" class="nav-link">Home</a>
          <a href="catalogo.html" class="nav-link">Annunci</a>
          <a href="admin-products.html" class="nav-link active">Admin</a>
        </nav>
      </div>
    </header>

    <main class="admin-container">
      <h1 id="page-title" style="color: #d4af37; margin-bottom: 30px;">Gestione Annunci</h1>

      <div id="alert-container"></div>

      <div class="admin-section publish-panel" id="publish-panel">
        <h2>Pubblica Annunci Online</h2>
        <p>Questa pagina modifica il catalogo locale del browser. Per rendere gli annunci visibili sul sito online devi pubblicare su GitHub.</p>
        <p><strong>Flusso consigliato (1 annuncio):</strong> carica foto → <strong>Riempi tutti i campi (AI)</strong> → <strong>Pubblica annuncio</strong>.</p>
        <ul>
          <li>modifica gli annunci qui;</li>
          <li>inserisci il Token GitHub e clicca <strong>Pubblica online adesso</strong> (pubblica tutto il catalogo);</li>
          <li>in alternativa: scarica <code>products.json</code> e fai commit/push manuale.</li>
        </ul>
	        <div class="file-inline" id="import-json-inline">
	          <label for="products-file-input">Importa products.json:</label>
	          <input type="file" id="products-file-input" accept="application/json">
	        </div>
	        <div class="file-inline auth-status" id="gh-login-status" style="display:none;">
	          <span id="gh-login-label" class="auth-status-label">Accesso admin attivo.</span>
	          <div class="publish-actions" style="margin-top:0;">
	            <button type="button" id="btn-gh-change-login" class="btn-secondary">Cambia accesso</button>
	            <button type="button" id="btn-gh-clear-login" class="btn-secondary">Disconnetti</button>
	          </div>
	        </div>
	        <div class="file-inline" id="gh-token-row">
	          <label for="gh-token">Accesso Admin (Token GitHub):</label>
	          <input type="password" id="gh-token" class="token-input" placeholder="github_pat_..." autocomplete="off" spellcheck="false" inputmode="text">
	          <label style="display:inline-flex;align-items:center;gap:8px;color:#bbb;">
	            <input type="checkbox" id="gh-remember">
	            Ricorda in questo browser
	          </label>
	        </div>
	        <details style="margin-top:10px;">
	          <summary style="cursor:pointer;color:#d4af37;font-weight:700;">AI automatica (1 click, senza chiavi sul telefono)</summary>
	          <p class="helper-note">Per usare <strong>Auto-compila (AI)</strong> imposta su GitHub un secret Actions: <code>OPENAI_API_KEY</code> (accettati anche <code>OPENAI_KEY</code> o <code>CHATGPT_API_KEY</code>). Opzionale: <code>OPENAI_MODEL</code>. Serve un account OpenAI API con billing/credito attivo. La chiave non viene mai salvata nel sito.</p>
	          <p class="helper-note">Se l'AI non e' configurata, usa <strong>Condividi prompt</strong> e incolla il JSON.</p>
	        </details>
	        <details style="margin-top:10px;">
	          <summary style="cursor:pointer;color:#d4af37;font-weight:700;">Impostazioni GitHub (repo/dominio)</summary>
	          <div class="config-grid">
	            <div class="form-group">
	              <label for="gh-owner">Owner</label>
	              <input type="text" id="gh-owner" placeholder="ensantiquarato o Egly87">
	            </div>
	            <div class="form-group">
	              <label for="gh-repo">Repository</label>
	              <input type="text" id="gh-repo" placeholder="ensantiquarato.github.io">
	            </div>
	            <div class="form-group">
	              <label for="gh-branch">Branch</label>
	              <input type="text" id="gh-branch" placeholder="main">
	            </div>
	            <div class="form-group">
	              <label for="gh-products-path">Path prodotti</label>
	              <input type="text" id="gh-products-path" placeholder="data/products.json">
	            </div>
	            <div class="form-group">
	              <label style="display:inline-flex;align-items:center;gap:10px;color:#bbb;margin-top:6px;">
	                <input type="checkbox" id="gh-use-raw">
	                Usa Raw URL per le foto (consigliato)
	              </label>
	            </div>
	          </div>
	          <p class="helper-note">Consiglio: usa token fine-grained, solo su questo repo, permesso <code>Contents: Read and write</code>, scadenza breve.</p>
	        </details>
		        <div class="publish-actions" id="bulk-actions">
		          <button type="button" id="btn-export-json" class="btn-secondary">Scarica products.json</button>
		          <button type="button" id="btn-sync-live" class="btn-secondary">Ricarica da dati pubblicati</button>
		          <button type="button" id="btn-copy-git" class="btn-secondary">Copia comandi Git</button>
		          <button type="button" id="btn-gh-publish" class="btn-secondary">Pubblica online adesso</button>
		        </div>
        <p id="publish-status" class="status-note">Annunci locali: 0.</p>
      </div>

	      <!-- Form Aggiunta/Modifica Prodotto -->
		      <div class="admin-section" id="insert-section">
		        <h2>Aggiungi o Modifica Annuncio</h2>
		        <div class="simple-flow" id="simple-flow">
		          <h3>Inserimento rapido</h3>
		          <ol>
		            <li>Incolla il token GitHub.</li>
		            <li>Seleziona le foto.</li>
		            <li>Premi <strong>Riempi tutti i campi (AI)</strong>.</li>
		            <li>Controlla i dati e premi <strong>Pubblica annuncio</strong>.</li>
		          </ol>
		        </div>
		        <form id="product-form">
		          <details open style="margin: 0 0 12px;">
		            <summary style="cursor:pointer;color:#d4af37;font-weight:700;">Step 1 — Carica foto su GitHub (JPG ottimizzate)</summary>
		            <p class="helper-note">Seleziona le foto dal telefono/PC: verranno caricate in <code>assets/products/</code> sul repo GitHub (serve Token GitHub in alto). Le convertiamo in <strong>JPG</strong> (piu compatibile sui telefoni).</p>
		            <p class="helper-note"><strong>1 click:</strong> seleziona foto → <strong>Riempi tutti i campi (AI)</strong> (fa anche l'upload) → <strong>Pubblica annuncio</strong>.</p>
		            <div class="form-row">
		              <div class="form-group">
		                <label for="gh-image-prefix">Nome file base (opzionale)</label>
		                <input type="text" id="gh-image-prefix" placeholder="es: giacca-pelle-vintage">
		              </div>
		              <div class="form-group">
		                <label for="gh-images-input">Foto (max 10, supporto HEIC/HEIF)</label>
		                <input type="file" id="gh-images-input" accept="image/*,.heic,.HEIC,.hiec,.HIEC,.heif,.HEIF" multiple>
		              </div>
		            </div>
	            <div class="publish-actions">
	              <button type="button" id="btn-gh-upload-images" class="btn-secondary">Carica foto adesso</button>
	              <button type="button" id="btn-ai-autofill" class="btn-secondary">Riempi tutti i campi (AI)</button>
	              <button type="button" id="btn-publish-ad" class="btn-secondary">Pubblica annuncio</button>
	            </div>
	            <div id="gh-upload-preview" class="upload-preview"></div>
	            <p id="gh-upload-status" class="status-note">Nessuna foto caricata.</p>
	            <div id="gh-upload-links" class="helper-note"></div>
	          </details>

		          <details style="margin: 0 0 12px;" id="manual-ai-step">
		            <summary style="cursor:pointer;color:#d4af37;font-weight:700;">Step 2 (Avanzato) — Prompt manuale ChatGPT</summary>
		            <p class="helper-note">Se l'AI automatica non e' configurata su GitHub, usa questo fallback: copia/condividi un prompt e incolla il JSON qui.</p>
	            <div class="publish-actions" style="margin: 10px 0 0;">
	              <button type="button" id="btn-copy-chatgpt-prompt" class="btn-secondary">Copia prompt ChatGPT</button>
	              <button type="button" id="btn-share-chatgpt-prompt" class="btn-secondary">Condividi prompt</button>
	            </div>
		            <textarea id="draft-json" class="draft-box" placeholder="{\n  &quot;name&quot;: &quot;...&quot;,\n  &quot;section&quot;: &quot;usato&quot;,\n  &quot;category&quot;: &quot;moda&quot;,\n  &quot;location&quot;: &quot;Roma&quot;,\n  &quot;condition&quot;: &quot;Ottimo&quot;,\n  &quot;postedAt&quot;: &quot;2026-02-08&quot;,\n  &quot;description&quot;: &quot;...&quot;,\n  &quot;price&quot;: 0,\n  &quot;shippingCost&quot;: 0,\n  &quot;year&quot;: &quot;...&quot;,\n  &quot;dimensions&quot;: &quot;...&quot;,\n  &quot;status&quot;: &quot;available&quot;,\n  &quot;featured&quot;: false,\n  &quot;image&quot;: &quot;assets/products/...&quot;,\n  &quot;gallery&quot;: [&quot;assets/products/...&quot;],\n  &quot;stripeLinkBuy&quot;: &quot;&quot;,\n  &quot;paypalBuy&quot;: &quot;&quot;,\n  &quot;whatsappText&quot;: &quot;...&quot;\n}"></textarea>
		            <div class="publish-actions" style="margin-top:10px;">
		              <button type="button" id="btn-apply-draft" class="btn-secondary">Inserisci dalla bozza</button>
		              <button type="button" id="btn-insert-from-draft" class="btn-secondary">Inserisci dalla bozza + vai al form</button>
		              <button type="button" id="btn-clear-draft" class="btn-secondary">Pulisci bozza</button>
		            </div>
		            <p class="helper-note">Dopo l'approvazione puoi usare <strong>Inserisci online</strong> in basso, oppure pubblicare una bozza specifica dalla lista annunci.</p>
		          </details>

          <div class="form-row">
            <div class="form-group">
              <label for="name">Titolo *</label>
              <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
              <label for="category">Categoria *</label>
              <select id="category" name="category" required>
                <option value="">-- Seleziona --</option>
                <option value="mobili">Mobili</option>
                <option value="arte">Arte</option>
                <option value="ceramica">Ceramica</option>
                <option value="orologeria">Orologeria</option>
                <option value="oggetti">Oggetti</option>
                <option value="gioielli">Gioielli</option>
                <option value="moda">Moda</option>
                <option value="elettronica">Elettronica</option>
                <option value="casa">Casa</option>
                <option value="sport">Sport e tempo libero</option>
                <option value="auto">Auto e moto</option>
                <option value="bimbi">Bimbi</option>
                <option value="collezionismo">Collezionismo</option>
                <option value="libri">Libri</option>
                <option value="altro">Altro</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="section">Sezione *</label>
              <select id="section" name="section" required>
                <option value="antiquariato">Antiquariato</option>
                <option value="usato">Usato</option>
              </select>
            </div>
            <div class="form-group">
              <label for="location">Zona</label>
              <input type="text" id="location" name="location" placeholder="Citta, provincia o regione">
            </div>
          </div>

          <div class="form-group">
            <label for="description">Descrizione *</label>
            <textarea id="description" name="description" required></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="price">Prezzo (€) *</label>
              <input type="number" id="price" name="price" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label for="shipping-cost">Spese spedizione (€) *</label>
              <input type="number" id="shipping-cost" name="shippingCost" step="0.01" min="0" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="year">Periodo (es: 1880-1890)</label>
              <input type="text" id="year" name="year">
            </div>
          </div>

          <div class="form-group">
            <label for="dimensions">Dimensioni</label>
            <input type="text" id="dimensions" name="dimensions" placeholder="L 120cm × H 90cm × P 50cm">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="condition">Condizione</label>
              <input type="text" id="condition" name="condition" placeholder="Nuovo, ottimo, buono, da sistemare...">
            </div>
            <div class="form-group">
              <label for="postedAt">Data annuncio</label>
              <input type="date" id="postedAt" name="postedAt">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="status">Stato *</label>
              <select id="status" name="status" required>
                <option value="available">Disponibile</option>
                <option value="reserved">Prenotato</option>
                <option value="sold">Venduto</option>
              </select>
            </div>
            <div class="form-group">
              <label for="featured">
                <input type="checkbox" id="featured" name="featured"> Featured (In primo piano)
              </label>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="stripe-link">Link Stripe per pagamento</label>
              <input type="url" id="stripe-link" name="stripeLinkBuy" placeholder="https://buy.stripe.com/...">
            </div>
            <div class="form-group">
              <label for="paypal-link">Link PayPal per pagamento</label>
              <input type="url" id="paypal-link" name="paypalBuy" placeholder="https://www.paypal.com/...">
            </div>
          </div>

          <div class="form-group">
            <label for="whatsapp-text">Testo WhatsApp</label>
            <input type="text" id="whatsapp-text" name="whatsappText" placeholder="Testo da inviare su WhatsApp">
          </div>

          <div class="form-group">
            <label for="image-url">Immagine Principale (path)</label>
            <input type="text" id="image-url" name="image" placeholder="assets/products/..." spellcheck="false" autocapitalize="none">
          </div>

	          <div class="form-group">
	            <label for="gallery-urls">URL Galleria (separati da virgola)</label>
	            <input type="text" id="gallery-urls" name="gallery" placeholder="assets/products/1.jpg, assets/products/2.jpg">
	          </div>

			          <div style="display: flex; gap: 10px; flex-wrap: wrap;" id="draft-actions">
			            <button type="submit" class="btn-secondary" id="btn-save-product">Salva bozza (solo locale)</button>
			            <button type="button" class="btn-secondary" id="btn-publish-ad-inline">Inserisci online</button>
			            <button type="button" class="btn-secondary" id="btn-clear">Pulisci</button>
			          </div>
	        </form>
	      </div>

	      <!-- Lista Prodotti -->
	      <div class="admin-section" id="products-section">
	        <h2>Annunci Attuali (<span id="product-count">0</span>)</h2>
	        <div id="products-list" class="products-grid"></div>
	      </div>
    </main>

    <footer style="text-align: center; padding: 20px; color: #666; margin-top: 40px;">
      <p>© 2026 ENS Vintage - Admin</p>
    </footer>
  </div>

  <script>
		    // Gestione LocalStorage per prodotti
		    const STORAGE_KEY = 'antiquariato_products';
		    const LIVE_DATA_PATH = 'data/products.json';
		    const GITHUB_TOKEN_STORAGE_KEY = 'ens_admin_github_token';
		    const GITHUB_CONFIG_STORAGE_KEY = 'ens_admin_github_config';
	    const PUBLIC_SITE_BASE = new URL('./', window.location.href).toString();
	    const INSERT_ONLY_MODE = new URLSearchParams(window.location.search).get('insert') === '1';

		    const DEFAULT_GITHUB_CONFIG = {
		      owner: 'Egly87',
		      repo: 'ensantiquarato.github.io',
		      branch: 'main',
		      productsPath: 'data/products.json',
		      imagesDir: 'assets/products',
		      useRawUrls: true
		    };

	    function applyInsertOnlyMode() {
	      if (!INSERT_ONLY_MODE) return;
	      document.title = 'Inserisci Annuncio - ENS Vintage';
	      const pageTitle = document.getElementById('page-title');
	      if (pageTitle) pageTitle.textContent = 'Inserisci Annuncio';

	      const hideIds = [
	        'import-json-inline',
	        'bulk-actions',
	        'products-section',
	        'manual-ai-step',
	        'draft-actions'
	      ];
	      hideIds.forEach((id) => {
	        const el = document.getElementById(id);
	        if (el) el.style.display = 'none';
	      });
	    }

    function loadProducts() {
      try {
        const json = localStorage.getItem(STORAGE_KEY);
        return json ? JSON.parse(json) : [];
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    function saveProducts(products) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
      renderProducts();
    }

    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alert);
      setTimeout(() => alert.remove(), 4000);
    }

    function updatePublishStatus() {
      const count = loadProducts().length;
      const statusEl = document.getElementById('publish-status');
      if (statusEl) {
        statusEl.textContent = `Annunci locali: ${count}.`;
      }
    }

	    function generateId() {
	      return Math.max(0, ...loadProducts().map(p => p.id || 0)) + 1;
	    }

	    function slugify(s) {
	      return String(s || '')
	        .toLowerCase()
	        .trim()
	        .replace(/[^a-z0-9\s-]/g, '')
	        .replace(/\s+/g, '-')
	        .replace(/-+/g, '-');
	    }

	    function loadGithubConfig() {
	      try {
	        const raw = localStorage.getItem(GITHUB_CONFIG_STORAGE_KEY);
	        if (!raw) return { ...DEFAULT_GITHUB_CONFIG };
	        const parsed = JSON.parse(raw);
	        return { ...DEFAULT_GITHUB_CONFIG, ...(parsed || {}) };
	      } catch {
	        return { ...DEFAULT_GITHUB_CONFIG };
	      }
	    }

	    function saveGithubConfig(cfg) {
	      const safe = {
	        owner: String(cfg.owner || '').trim() || DEFAULT_GITHUB_CONFIG.owner,
	        repo: String(cfg.repo || '').trim() || DEFAULT_GITHUB_CONFIG.repo,
	        branch: String(cfg.branch || '').trim() || DEFAULT_GITHUB_CONFIG.branch,
	        productsPath: String(cfg.productsPath || '').trim() || DEFAULT_GITHUB_CONFIG.productsPath,
	        imagesDir: String(cfg.imagesDir || '').trim() || DEFAULT_GITHUB_CONFIG.imagesDir,
	        useRawUrls: cfg.useRawUrls === false ? false : true
	      };
	      localStorage.setItem(GITHUB_CONFIG_STORAGE_KEY, JSON.stringify(safe));
	      return safe;
	    }

    function loadGithubToken() {
      return sessionStorage.getItem(GITHUB_TOKEN_STORAGE_KEY)
        || localStorage.getItem(GITHUB_TOKEN_STORAGE_KEY)
        || '';
    }

	    function saveGithubToken(token, remember) {
	      // Never store on the server; this is client-only. Still: treat it as sensitive.
	      sessionStorage.removeItem(GITHUB_TOKEN_STORAGE_KEY);
	      localStorage.removeItem(GITHUB_TOKEN_STORAGE_KEY);
	      if (!token) return;
	      if (remember) localStorage.setItem(GITHUB_TOKEN_STORAGE_KEY, token);
	      else sessionStorage.setItem(GITHUB_TOKEN_STORAGE_KEY, token);
	    }

		    function isHeicOrHeifFile(file) {
		      if (!file) return false;
		      const type = String(file.type || '').toLowerCase();
		      const name = String(file.name || '').toLowerCase();
		      return type.includes('heic')
		        || type.includes('heif')
		        || name.endsWith('.heic')
		        || name.endsWith('.hiec')
		        || name.endsWith('.heif');
		    }

	    let heic2anyLoaderPromise = null;
	    async function loadHeic2Any() {
	      if (typeof window.heic2any === 'function') return window.heic2any;
	      if (heic2anyLoaderPromise) return heic2anyLoaderPromise;
	      heic2anyLoaderPromise = new Promise((resolve, reject) => {
	        const script = document.createElement('script');
	        script.src = 'https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js';
	        script.async = true;
	        script.onload = () => {
	          if (typeof window.heic2any === 'function') resolve(window.heic2any);
	          else reject(new Error('Libreria HEIC non disponibile.'));
	        };
	        script.onerror = () => reject(new Error('Impossibile caricare la libreria HEIC.'));
	        document.head.appendChild(script);
	      });
	      return heic2anyLoaderPromise;
	    }

	    async function convertHeicToJpegBlob(file) {
	      const heic2any = await loadHeic2Any();
	      const out = await heic2any({
	        blob: file,
	        toType: 'image/jpeg',
	        quality: 0.92
	      });
	      const first = Array.isArray(out) ? out[0] : out;
	      if (!(first instanceof Blob)) throw new Error('Conversione HEIC fallita.');
	      return first;
	    }

	    function getSelectedImages(max = 10) {
	      const selected = Array.from(document.getElementById('gh-images-input')?.files || []);
	      if (!selected.length) return [];
	      return selected.slice(0, max);
	    }

		    function base64EncodeUnicode(str) {
		      return btoa(unescape(encodeURIComponent(str)));
		    }

	    async function fileToBase64(file) {
	      return new Promise((resolve, reject) => {
	        const reader = new FileReader();
	        reader.onerror = () => reject(new Error('Impossibile leggere il file'));
	        reader.onload = () => {
	          const result = String(reader.result || '');
	          const comma = result.indexOf(',');
	          if (comma === -1) return reject(new Error('Formato base64 non valido'));
	          resolve(result.slice(comma + 1));
	        };
	        reader.readAsDataURL(file);
	      });
	    }

	    function scaleToMaxSize(width, height, maxSize) {
	      const w = Number(width) || 0;
	      const h = Number(height) || 0;
	      if (!w || !h) return { width: w, height: h };
	      const maxDim = Math.max(w, h);
	      if (!maxSize || maxDim <= maxSize) return { width: w, height: h };
	      const scale = maxSize / maxDim;
	      return { width: Math.max(1, Math.round(w * scale)), height: Math.max(1, Math.round(h * scale)) };
	    }

	    function canvasToBlob(canvas, type, quality) {
	      return new Promise((resolve) => {
	        canvas.toBlob((blob) => resolve(blob), type, quality);
	      });
	    }

	    async function convertImageToJpeg(file, { maxSize = 1600, quality = 0.86 } = {}) {
	      let sourceFile = file;
	      if (isHeicOrHeifFile(file)) {
	        try {
	          sourceFile = await convertHeicToJpegBlob(file);
	        } catch (err) {
	          const msg = err && err.message ? err.message : 'Conversione HEIC fallita.';
	          throw new Error(`HEIC/HEIF non convertibile (${String(file.name || 'file')}). ${msg}`);
	        }
	      }

	      // Try createImageBitmap first (handles EXIF orientation on supporting browsers).
	      let bitmap = null;
	      if (typeof createImageBitmap === 'function') {
	        try {
	          bitmap = await createImageBitmap(sourceFile, { imageOrientation: 'from-image' });
	        } catch {
	          try { bitmap = await createImageBitmap(sourceFile); } catch { bitmap = null; }
	        }
	      }

	      try {
	        let srcW = 0;
	        let srcH = 0;
	        if (bitmap) {
	          srcW = bitmap.width;
	          srcH = bitmap.height;
	        } else {
	          const url = URL.createObjectURL(sourceFile);
	          try {
	            const img = await new Promise((resolve, reject) => {
	              const el = new Image();
	              el.onload = () => resolve(el);
	              el.onerror = () => reject(new Error('Formato immagine non supportato dal browser'));
	              el.src = url;
	            });
	            srcW = img.naturalWidth || img.width;
	            srcH = img.naturalHeight || img.height;
	            bitmap = img;
	          } finally {
	            URL.revokeObjectURL(url);
	          }
	        }

	        const target = scaleToMaxSize(srcW, srcH, maxSize);
	        const canvas = document.createElement('canvas');
	        canvas.width = target.width;
	        canvas.height = target.height;
	        const ctx = canvas.getContext('2d', { alpha: false });
	        if (!ctx) throw new Error('Impossibile creare canvas');
	        // Ensure a clean background (important if source has transparency).
	        ctx.fillStyle = '#ffffff';
	        ctx.fillRect(0, 0, target.width, target.height);
	        ctx.drawImage(bitmap, 0, 0, target.width, target.height);

	        const blob = await canvasToBlob(canvas, 'image/jpeg', quality);
	        if (!blob) throw new Error('Conversione JPG fallita');
	        return blob;
	      } finally {
	        try { if (bitmap && typeof bitmap.close === 'function') bitmap.close(); } catch {}
	      }
	    }

    async function githubRequest(url, { method = 'GET', token = '', body = null } = {}) {
      const headers = {
        'Accept': 'application/vnd.github+json',
        'X-GitHub-Api-Version': '2022-11-28'
      };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      if (body !== null) headers['Content-Type'] = 'application/json';

      const res = await fetch(url, {
        method,
        headers,
        body: body === null ? null : JSON.stringify(body)
      });

      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = text; }

      if (!res.ok) {
        const msg = data && typeof data === 'object' && data.message ? data.message : String(text || res.statusText);
        throw new Error(`GitHub API ${res.status}: ${msg}`);
      }
      return data;
    }

	    async function publishProductsToGithub(products) {
	      const cfg = loadGithubConfig();
	      const token = loadGithubToken();
	      if (!token) {
	        throw new Error('Inserisci il Token GitHub per pubblicare online.');
	      }
	      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.productsPath}`;

	      // 1) Get current sha
	      const current = await githubRequest(`${url}?ref=${encodeURIComponent(cfg.branch)}`, { token });
	      const sha = current && current.sha ? current.sha : null;
	      if (!sha) throw new Error('Impossibile leggere lo SHA del file remoto.');

      // 2) Upload new content
      const json = JSON.stringify(products, null, 2) + '\n';
      const now = new Date();
      const stamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
	      const payload = {
	        message: `Aggiorna annunci (${stamp})`,
	        content: base64EncodeUnicode(json),
	        sha,
	        branch: cfg.branch
	      };

      try {
        return await githubRequest(url, { method: 'PUT', token, body: payload });
      } catch (err) {
	        // If there was a race (file updated), refresh sha and retry once.
	        if (String(err.message || '').includes('409')) {
	          const refreshed = await githubRequest(`${url}?ref=${encodeURIComponent(cfg.branch)}`, { token });
	          const newSha = refreshed && refreshed.sha ? refreshed.sha : null;
	          if (!newSha) throw err;
	          payload.sha = newSha;
	          return await githubRequest(url, { method: 'PUT', token, body: payload });
	        }
        throw err;
      }
	    }

	    async function uploadImagesToGithub(files, baseName) {
	      const cfg = loadGithubConfig();
	      const token = loadGithubToken();
	      if (!token) throw new Error('Inserisci il Token GitHub per caricare le foto.');
	      if (!files || !files.length) throw new Error('Seleziona almeno una foto.');
	      if (files.length > 10) throw new Error('Massimo 10 foto per annuncio.');

	      const base = slugify(baseName) || `p${Date.now()}`;
	      const uploaded = [];

	      for (let i = 0; i < files.length; i++) {
	        const file = files[i];
	        const filename = `${base}-${i + 1}.jpg`;
		        const path = `${cfg.imagesDir.replace(/\/$/, '')}/${filename}`.replace(/^\/+/, '');
	        const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${path}`;

	        // Check if exists -> sha
	        let sha = null;
	        try {
	          const current = await githubRequest(`${url}?ref=${encodeURIComponent(cfg.branch)}`, { token });
	          sha = current && current.sha ? current.sha : null;
	        } catch (err) {
	          // 404 is fine (create new)
	          if (!String(err.message || '').includes('404')) throw err;
	        }

	        const jpgBlob = await convertImageToJpeg(file, { maxSize: 1600, quality: 0.86 });
	        const base64 = await fileToBase64(jpgBlob);
	        const payload = {
	          message: `Carica foto annuncio: ${filename}`,
	          content: base64,
	          branch: cfg.branch
	        };
	        if (sha) payload.sha = sha;

	        const res = await githubRequest(url, { method: 'PUT', token, body: payload });
	        const downloadUrl = res && res.content && res.content.download_url ? res.content.download_url : '';
	        uploaded.push({ path, downloadUrl });
	      }

	      return uploaded;
	    }

	    async function loadLiveProducts() {
      const response = await fetch(LIVE_DATA_PATH);
      if (!response.ok) {
        throw new Error('Impossibile leggere data/products.json');
      }
      const products = await response.json();
      if (!Array.isArray(products)) {
        throw new Error('Il file data/products.json non contiene un array');
      }
      return products;
    }

    async function initializeProductsIfEmpty() {
      const products = loadProducts();
      if (products.length > 0) {
        renderProducts();
        return;
      }
      try {
        const liveProducts = await loadLiveProducts();
        saveProducts(liveProducts);
        showAlert('Catalogo inizializzato dai dati pubblicati.');
      } catch (err) {
        showAlert(err.message, 'error');
      }
    }

    function downloadProductsJson() {
      const products = loadProducts();
      const blob = new Blob([JSON.stringify(products, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'products.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function formatPriceForAd(product) {
      if (typeof product.price === 'number' && !Number.isNaN(product.price)) {
        return `EUR ${product.price.toFixed(2)}`;
      }
      return 'Su richiesta';
    }

    function buildProductUrl(productId) {
      return new URL(`prodotto.html?id=${productId}`, PUBLIC_SITE_BASE).toString();
    }

    async function copyTextToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return;
      }
      const area = document.createElement('textarea');
      area.value = text;
      document.body.appendChild(area);
      area.select();
      document.execCommand('copy');
      area.remove();
    }

    async function copyAdText(productId) {
      const product = loadProducts().find((p) => p.id === productId);
      if (!product) {
        showAlert('Annuncio non trovato.', 'error');
        return;
      }
      const adText = [
        `${product.name}`,
        `Prezzo: ${formatPriceForAd(product)}`,
        `Sezione: ${product.section || 'antiquariato'}`,
        `Categoria: ${product.category || 'N/D'}`,
        `Zona: ${product.location || 'N/D'}`,
        `Condizione: ${product.condition || 'N/D'}`,
        `Spedizione: EUR ${Number(product.shippingCost || 0).toFixed(2)}`,
        `Periodo: ${product.year || 'N/D'}`,
        product.description || '',
        `Link: ${buildProductUrl(product.id)}`,
        `Email: egli87@yahoo.com`,
        `Contatto: +39 329 662 7575`
      ].filter(Boolean).join('\n');

      try {
        await copyTextToClipboard(adText);
        showAlert('Testo annuncio copiato.');
      } catch (err) {
        console.error(err);
        showAlert('Impossibile copiare il testo annuncio.', 'error');
      }
    }

	    // Form submission
		    document.getElementById('product-form').addEventListener('submit', async (e) => {
		      e.preventDefault();
		      const form = e.target;
		      const formData = new FormData(form);
		      const parsedPrice = parseFloat(formData.get('price'));
		      const parsedShipping = parseFloat(formData.get('shippingCost'));
		      const postedAtRaw = String(formData.get('postedAt') || '').trim();
	      
	      const product = {
	        id: parseInt(formData.get('id')) || generateId(),
	        name: formData.get('name'),
	        section: String(formData.get('section') || '').trim() || 'antiquariato',
	        category: formData.get('category'),
	        location: String(formData.get('location') || '').trim(),
	        condition: String(formData.get('condition') || '').trim(),
	        postedAt: postedAtRaw || new Date().toISOString().slice(0, 10),
	        description: formData.get('description'),
	        price: Number.isFinite(parsedPrice) ? parsedPrice : 0,
	        shippingCost: Number.isFinite(parsedShipping) ? parsedShipping : 0,
	        year: formData.get('year'),
	        dimensions: formData.get('dimensions'),
	        status: formData.get('status'),
	        featured: formData.get('featured') ? true : false,
	        image: formData.get('image'),
	        gallery: String(formData.get('gallery') || '')
	          .split(',')
	          .map(url => String(url || '').trim())
	          .filter(url => url),
	        stripeLinkBuy: formData.get('stripeLinkBuy'),
	        paypalBuy: formData.get('paypalBuy'),
	        whatsappText: formData.get('whatsappText')
	      };

      let products = loadProducts();
      const index = products.findIndex(p => p.id === product.id);
      const existing = index >= 0 ? products[index] : null;

      // Preserve stable fields on update if the form left them empty.
      if (existing) {
        if (!product.postedAt && existing.postedAt) product.postedAt = existing.postedAt;
        if (!product.section && existing.section) product.section = existing.section;
      }
      
      let saveLabel = '';
      if (index >= 0) {
        products[index] = product;
        saveLabel = '✅ Annuncio aggiornato';
      } else {
        products.push(product);
        saveLabel = '✅ Annuncio aggiunto';
      }

	      saveProducts(products);
	      showAlert(`${saveLabel}. Ora premi "Pubblica annuncio" per renderlo visibile sul sito.`);

	      form.reset();
	      const postedAtEl = document.getElementById('postedAt');
	      if (postedAtEl) postedAtEl.value = new Date().toISOString().slice(0, 10);
	      const shippingEl = document.getElementById('shipping-cost');
	      if (shippingEl && !shippingEl.value) shippingEl.value = '0';
	      document.getElementById('product-form').querySelector('input[name="id"]')?.remove();
	      document.getElementById('btn-save-product').textContent = 'Salva bozza (solo locale)';
	    });

	    document.getElementById('btn-clear').addEventListener('click', () => {
	      document.getElementById('product-form').reset();
	      const postedAtEl = document.getElementById('postedAt');
	      if (postedAtEl) postedAtEl.value = new Date().toISOString().slice(0, 10);
	      const shippingEl = document.getElementById('shipping-cost');
	      if (shippingEl && !shippingEl.value) shippingEl.value = '0';
	      document.getElementById('product-form').querySelector('input[name="id"]')?.remove();
	      document.getElementById('btn-save-product').textContent = 'Salva bozza (solo locale)';
	    });

    document.getElementById('btn-export-json').addEventListener('click', () => {
      downloadProductsJson();
      showAlert('File products.json scaricato.');
    });

    document.getElementById('btn-sync-live').addEventListener('click', async () => {
      if (!confirm('Sostituire il catalogo locale con i dati attualmente pubblicati?')) return;
      try {
        const liveProducts = await loadLiveProducts();
        saveProducts(liveProducts);
        showAlert('Annunci locali sincronizzati con i dati pubblicati.');
      } catch (err) {
        showAlert(err.message, 'error');
      }
    });

    document.getElementById('products-file-input').addEventListener('change', async (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) {
          throw new Error('Il file selezionato non contiene un array di prodotti.');
        }
        saveProducts(parsed);
        showAlert('Catalogo importato dal file selezionato.');
      } catch (err) {
        showAlert(err.message, 'error');
      }
    });

    document.getElementById('btn-copy-git').addEventListener('click', async () => {
      const gitCommands = [
        'cp ~/Downloads/products.json data/products.json',
        'git add data/products.json',
        'git commit -m "Aggiorna annunci"',
        'git push origin main'
      ].join('\n');
      try {
        await copyTextToClipboard(gitCommands);
        showAlert('Comandi Git copiati negli appunti.');
      } catch (err) {
        showAlert('Impossibile copiare i comandi Git.', 'error');
      }
    });

		    // GitHub token field (client-side "login")
		    (function initGithubTokenUi() {
		      const tokenInput = document.getElementById('gh-token');
		      const rememberCheckbox = document.getElementById('gh-remember');
		      const tokenRow = document.getElementById('gh-token-row');
		      const loginStatusRow = document.getElementById('gh-login-status');
		      const loginStatusLabel = document.getElementById('gh-login-label');
		      const changeLoginBtn = document.getElementById('btn-gh-change-login');
		      const clearLoginBtn = document.getElementById('btn-gh-clear-login');
		      const ownerInput = document.getElementById('gh-owner');
		      const repoInput = document.getElementById('gh-repo');
		      const branchInput = document.getElementById('gh-branch');
		      const productsPathInput = document.getElementById('gh-products-path');
		      const useRawCheckbox = document.getElementById('gh-use-raw');

		      function maskToken(token) {
		        const t = String(token || '').trim();
		        if (!t) return '';
		        if (t.length <= 10) return `${t.slice(0, 3)}...`;
		        return `${t.slice(0, 6)}...${t.slice(-4)}`;
		      }

		      function refreshAuthUi() {
		        const storedToken = loadGithubToken().trim();
		        const hasToken = !!storedToken;
		        if (!tokenInput.value.trim() && hasToken) tokenInput.value = storedToken;
		        if (tokenRow) tokenRow.style.display = hasToken ? 'none' : 'flex';
		        if (loginStatusRow) loginStatusRow.style.display = hasToken ? 'flex' : 'none';
		        if (loginStatusLabel && hasToken) {
		          loginStatusLabel.textContent = `Accesso admin attivo (${maskToken(storedToken)}).`;
		        }
		      }

		      const stored = loadGithubToken();
		      if (stored) tokenInput.value = stored;
		      // Default ON: users want fewer steps on mobile.
		      rememberCheckbox.checked = !!localStorage.getItem(GITHUB_TOKEN_STORAGE_KEY) || !sessionStorage.getItem(GITHUB_TOKEN_STORAGE_KEY);

		      const cfg = loadGithubConfig();
		      if (ownerInput) ownerInput.value = cfg.owner;
		      if (repoInput) repoInput.value = cfg.repo;
	      if (branchInput) branchInput.value = cfg.branch;
	      if (productsPathInput) productsPathInput.value = cfg.productsPath;
	      if (useRawCheckbox) useRawCheckbox.checked = cfg.useRawUrls !== false;

		      function persistToken() {
		        const token = tokenInput.value.trim();
		        saveGithubToken(token, rememberCheckbox.checked);
		        refreshAuthUi();
		      }
		      tokenInput.addEventListener('input', persistToken);
		      tokenInput.addEventListener('change', persistToken);
		      rememberCheckbox.addEventListener('change', () => {
		        persistToken();
		      });
		      changeLoginBtn?.addEventListener('click', () => {
		        if (tokenRow) tokenRow.style.display = 'flex';
		        if (loginStatusRow) loginStatusRow.style.display = 'none';
		        tokenInput.focus();
		      });
		      clearLoginBtn?.addEventListener('click', () => {
		        saveGithubToken('', true);
		        tokenInput.value = '';
		        refreshAuthUi();
		        showAlert('Accesso admin rimosso da questo browser.');
		      });

		      function persistCfg() {
		        saveGithubConfig({
		          owner: ownerInput ? ownerInput.value : '',
	          repo: repoInput ? repoInput.value : '',
	          branch: branchInput ? branchInput.value : '',
	          productsPath: productsPathInput ? productsPathInput.value : '',
	          useRawUrls: useRawCheckbox ? !!useRawCheckbox.checked : true
	        });
	      }
		      [ownerInput, repoInput, branchInput, productsPathInput, useRawCheckbox].forEach((el) => {
		        if (!el) return;
		        el.addEventListener('input', persistCfg);
		        el.addEventListener('change', persistCfg);
		      });
		      refreshAuthUi();
		    })();

	    document.getElementById('btn-gh-publish').addEventListener('click', async () => {
	      if (!confirm('Pubblicare online adesso? Questo aggiorna data/products.json su GitHub e rende gli annunci visibili sul sito.')) return;
	      try {
	        const products = loadProducts();
	        const result = await publishProductsToGithub(products);
	        const commitUrl = result && result.commit && result.commit.html_url ? result.commit.html_url : '';
	        showAlert(commitUrl ? `Pubblicato online! Commit: ${commitUrl}` : 'Pubblicato online!');
	      } catch (err) {
	        showAlert(err.message || 'Errore durante la pubblicazione.', 'error');
	      }
	    });

	    // Draft apply (ChatGPT -> form)
		    function applyDraftToForm(draft) {
		      if (!draft || typeof draft !== 'object') throw new Error('Bozza non valida.');
		      const draftIdRaw = parseInt(draft.id, 10);
		      const canApplyId = !INSERT_ONLY_MODE && Number.isFinite(draftIdRaw) && draftIdRaw > 0;
		      let idInput = document.querySelector('input[name="id"]');
		      if (canApplyId) {
		        if (!idInput) {
		          idInput = document.createElement('input');
		          idInput.type = 'hidden';
		          idInput.name = 'id';
		          document.getElementById('product-form').appendChild(idInput);
		        }
		        idInput.value = String(draftIdRaw);
		      } else if (idInput) {
		        idInput.remove();
		      }

	      if (draft.name) document.getElementById('name').value = String(draft.name);
	      if (draft.section != null) document.getElementById('section').value = String(draft.section || 'antiquariato');
	      if (draft.category) document.getElementById('category').value = String(draft.category);
	      if (draft.location != null) document.getElementById('location').value = String(draft.location || '');
	      if (draft.condition != null) document.getElementById('condition').value = String(draft.condition || '');
	      if (draft.postedAt != null) {
	        const raw = String(draft.postedAt || '').trim();
	        const datePart = raw.includes('T') ? raw.slice(0, 10) : raw;
	        document.getElementById('postedAt').value = datePart;
	      }
	      if (draft.description) document.getElementById('description').value = String(draft.description);
	      if (draft.price != null) document.getElementById('price').value = String(draft.price);
	      if (draft.shippingCost != null) document.getElementById('shipping-cost').value = String(draft.shippingCost);
	      if (draft.year) document.getElementById('year').value = String(draft.year);
	      if (draft.dimensions) document.getElementById('dimensions').value = String(draft.dimensions);
	      if (draft.status) document.getElementById('status').value = String(draft.status);
	      document.getElementById('featured').checked = !!draft.featured;
	      if (draft.stripeLinkBuy != null) document.getElementById('stripe-link').value = String(draft.stripeLinkBuy || '');
	      if (draft.paypalBuy != null) document.getElementById('paypal-link').value = String(draft.paypalBuy || '');
	      if (draft.whatsappText != null) document.getElementById('whatsapp-text').value = String(draft.whatsappText || '');
	      if (draft.image) document.getElementById('image-url').value = String(draft.image);
	      if (Array.isArray(draft.gallery)) document.getElementById('gallery-urls').value = draft.gallery.join(', ');

			      document.getElementById('btn-save-product').textContent = canApplyId ? 'Aggiorna bozza (solo locale)' : 'Salva bozza (solo locale)';
			    }

	    function insertFromDraftJson(scrollToForm = false) {
	      const txt = document.getElementById('draft-json')?.value.trim();
	      if (!txt) throw new Error('Incolla prima una bozza JSON.');
	      const parsed = JSON.parse(txt);
	      applyDraftToForm(parsed);
	      showAlert('Bozza inserita nel form.');
	      if (scrollToForm) {
	        document.getElementById('insert-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
	      } else {
	        window.scrollTo({ top: 0, behavior: 'smooth' });
	      }
	    }

	    document.getElementById('btn-apply-draft')?.addEventListener('click', () => {
	      try {
	        insertFromDraftJson(false);
	      } catch (err) {
	        showAlert(err.message || 'Errore parsing bozza JSON.', 'error');
	      }
	    });

	    document.getElementById('btn-insert-from-draft')?.addEventListener('click', () => {
	      try {
	        insertFromDraftJson(true);
	      } catch (err) {
	        showAlert(err.message || 'Errore parsing bozza JSON.', 'error');
	      }
	    });

	    document.getElementById('btn-clear-draft')?.addEventListener('click', () => {
	      const draftEl = document.getElementById('draft-json');
	      if (draftEl) draftEl.value = '';
	      showAlert('Bozza pulita.');
	    });

		    // GitHub image upload -> fills image + gallery
	    const imagesInput = document.getElementById('gh-images-input');
	    const imagesPreview = document.getElementById('gh-upload-preview');
	    const imagesStatus = document.getElementById('gh-upload-status');
	    const imagesLinks = document.getElementById('gh-upload-links');
	    let lastUploadedImages = [];
	    let lastUploadBase = '';
	    let previewObjectUrls = [];
	    function clearPreviewObjectUrls() {
	      previewObjectUrls.forEach((url) => {
	        try { URL.revokeObjectURL(url); } catch {}
	      });
	      previewObjectUrls = [];
	    }
	    if (imagesInput) {
	      imagesInput.addEventListener('change', () => {
	        const prefixEl = document.getElementById('gh-image-prefix');
	        const selectedCount = Array.from(imagesInput.files || []).length;
	        const files = getSelectedImages(10);
	        lastUploadedImages = [];
	        clearPreviewObjectUrls();
	        if (!lastUploadBase) lastUploadBase = `ad-${Date.now()}`;
	        if (prefixEl && !prefixEl.value.trim()) prefixEl.value = lastUploadBase;
	        if (imagesLinks) imagesLinks.innerHTML = '';
	        if (imagesPreview) {
		          imagesPreview.innerHTML = files.map((f) => {
		            const url = URL.createObjectURL(f);
		            previewObjectUrls.push(url);
	            return `<img src="${url}" alt="${f.name}">`;
	          }).join('');
	        }
	        if (imagesStatus) {
	          if (!files.length) {
	            imagesStatus.textContent = 'Nessuna foto caricata.';
	          } else if (selectedCount > 10) {
	            imagesStatus.textContent = `${selectedCount} foto selezionate: useremo solo le prime 10.`;
	          } else {
	            imagesStatus.textContent = `${files.length} foto selezionate (pronte per upload).`;
	          }
	        }
	      });
	    }

			    function setButtonsDisabled(disabled) {
			      ['btn-gh-upload-images', 'btn-ai-autofill', 'btn-publish-ad', 'btn-publish-ad-inline'].forEach((id) => {
			        const el = document.getElementById(id);
			        if (el) el.disabled = !!disabled;
			      });
			    }

			    function syncImageFieldsFromUploads() {
			      if (!lastUploadedImages.length) return;
			      const cfg = loadGithubConfig();
			      const useRaw = cfg.useRawUrls !== false;
			      const values = lastUploadedImages
			        .map((u) => (useRaw && u.rawUrl) ? u.rawUrl : (u.path || u.pagesUrl || ''))
			        .filter(Boolean);
			      if (!values.length) return;
			      const imageEl = document.getElementById('image-url');
			      const galleryEl = document.getElementById('gallery-urls');
			      if (imageEl && !String(imageEl.value || '').trim()) imageEl.value = values[0];
			      if (galleryEl && !String(galleryEl.value || '').trim()) galleryEl.value = values.join(', ');
			    }

	    async function ensureImagesUploaded() {
	      if (lastUploadedImages.length) return lastUploadedImages;

	      const files = getSelectedImages(10);
	      const prefixEl = document.getElementById('gh-image-prefix');
	      const prefix = (prefixEl && prefixEl.value.trim())
	        || slugify(document.getElementById('name')?.value)
	        || lastUploadBase
		        || `ad-${Date.now()}`;

		      if (!files.length) throw new Error('Seleziona almeno 1 foto.');

		      if (imagesStatus) imagesStatus.textContent = 'Upload foto in corso...';
		      setButtonsDisabled(true);

		      // Persist token even if mobile doesn't fire "change" reliably.
		      try {
		        const tokenInput = document.getElementById('gh-token');
		        const remember = document.getElementById('gh-remember');
		        if (tokenInput) saveGithubToken(tokenInput.value.trim(), !!remember?.checked);
		      } catch {}

		      const uploaded = await uploadImagesToGithub(files, prefix);
		      const cfg = loadGithubConfig();
		      const useRaw = cfg.useRawUrls !== false;

		      const paths = uploaded.map((u) => u.path);
		      const values = uploaded.map((u) => (useRaw && u.downloadUrl) ? u.downloadUrl : u.path);

		      if (values.length) {
		        document.getElementById('image-url').value = values[0];
		        document.getElementById('gallery-urls').value = values.join(', ');
		      }

		      lastUploadedImages = uploaded.map((u) => ({
		        path: u.path,
		        pagesUrl: new URL(u.path, PUBLIC_SITE_BASE).toString(),
		        rawUrl: u.downloadUrl || ''
		      }));

		      if (imagesLinks) {
		        const list = lastUploadedImages.map((u, idx) => {
		          const raw = u.rawUrl ? `<a href="${u.rawUrl}" target="_blank" rel="noopener">Raw</a>` : 'Raw';
		          return `<div><strong>${idx + 1}.</strong> <a href="${u.pagesUrl}" target="_blank" rel="noopener">Pages</a> · ${raw}</div>`;
		        }).join('');
		        imagesLinks.innerHTML = `<div style="margin-top:8px;"><strong>Link foto:</strong> (Pages puo' richiedere 1-3 min)</div>${list}`;
		      }

		      if (imagesStatus) imagesStatus.textContent = `Upload completato: ${paths.length} foto.`;
		      setButtonsDisabled(false);
		      return lastUploadedImages;
		    }

		    document.getElementById('btn-gh-upload-images')?.addEventListener('click', async () => {
		      try {
		        await ensureImagesUploaded();
		        showAlert('Foto caricate e collegate all\'annuncio.');
		      } catch (err) {
		        if (imagesStatus) imagesStatus.textContent = `Upload fallito: ${err && err.message ? err.message : 'errore sconosciuto'}`;
		        setButtonsDisabled(false);
		        showAlert(err.message || 'Errore upload immagini.', 'error');
		      }
		    });

		    document.getElementById('btn-ai-autofill')?.addEventListener('click', async () => {
		      try {
		        await ensureImagesUploaded();
		        if (imagesStatus) imagesStatus.textContent = 'Compilazione AI in corso...';
		        setButtonsDisabled(true);
		        await runServerAiAutofill();
		        if (imagesStatus) imagesStatus.textContent = 'Compilazione AI completata.';
		        showAlert('Campi compilati automaticamente. Controlla e poi premi "Pubblica annuncio".');
		      } catch (err) {
		        if (imagesStatus) imagesStatus.textContent = `Compilazione AI fallita: ${err && err.message ? err.message : 'errore sconosciuto'}`;
		        showAlert(err.message || 'AI: compilazione fallita.', 'error');
		      } finally {
		        setButtonsDisabled(false);
		      }
		    });

		    function getFirstMissingFieldId(product) {
		      if (!String(product.name || '').trim()) return 'name';
		      if (!String(product.category || '').trim()) return 'category';
		      if (!String(product.section || '').trim()) return 'section';
		      if (!String(product.description || '').trim()) return 'description';
		      if (!String(document.getElementById('shipping-cost')?.value || '').trim()) return 'shipping-cost';
		      if (!String(product.image || '').trim()) return 'image-url';
		      if (!Array.isArray(product.gallery) || product.gallery.length === 0) return 'gallery-urls';
		      return '';
		    }

			    function readProductFromForm() {
			      const form = document.getElementById('product-form');
			      const formData = new FormData(form);
			      const parsedPrice = parseFloat(formData.get('price'));
			      const parsedShipping = parseFloat(formData.get('shippingCost'));
			      const postedAtRaw = String(formData.get('postedAt') || '').trim();
			      const explicitId = parseInt(formData.get('id'), 10);
			      const nextId = INSERT_ONLY_MODE
			        ? generateId()
			        : (Number.isFinite(explicitId) && explicitId > 0 ? explicitId : generateId());
			      return {
		        id: nextId,
		        name: String(formData.get('name') || ''),
		        section: String(formData.get('section') || '').trim() || 'antiquariato',
		        category: String(formData.get('category') || ''),
		        location: String(formData.get('location') || '').trim(),
		        condition: String(formData.get('condition') || '').trim(),
		        postedAt: postedAtRaw || new Date().toISOString().slice(0, 10),
		        description: String(formData.get('description') || ''),
		        price: Number.isFinite(parsedPrice) ? parsedPrice : 0,
		        shippingCost: Number.isFinite(parsedShipping) ? parsedShipping : 0,
		        year: String(formData.get('year') || ''),
		        dimensions: String(formData.get('dimensions') || ''),
		        status: String(formData.get('status') || 'available'),
		        featured: formData.get('featured') ? true : false,
		        image: String(formData.get('image') || ''),
		        gallery: String(formData.get('gallery') || '')
		          .split(',')
		          .map(url => String(url || '').trim())
		          .filter(url => url),
		        stripeLinkBuy: String(formData.get('stripeLinkBuy') || ''),
		        paypalBuy: String(formData.get('paypalBuy') || ''),
		        whatsappText: String(formData.get('whatsappText') || '')
		      };
		    }

			    function resetProductForm() {
			      const form = document.getElementById('product-form');
			      form.reset();
			      const postedAtEl = document.getElementById('postedAt');
			      if (postedAtEl) postedAtEl.value = new Date().toISOString().slice(0, 10);
			      const shippingEl = document.getElementById('shipping-cost');
			      if (shippingEl && !shippingEl.value) shippingEl.value = '0';
			      document.querySelector('input[name=\"id\"]')?.remove();
			      document.getElementById('btn-save-product').textContent = 'Salva bozza (solo locale)';
			    }

	    function clearSelectedImages() {
	      const input = document.getElementById('gh-images-input');
	      if (input) input.value = '';
	      lastUploadedImages = [];
	      lastUploadBase = `ad-${Date.now()}`;
	      clearPreviewObjectUrls();
	      const prefixEl = document.getElementById('gh-image-prefix');
	      if (prefixEl) prefixEl.value = lastUploadBase;
	      if (imagesPreview) imagesPreview.innerHTML = '';
		      if (imagesLinks) imagesLinks.innerHTML = '';
		      if (imagesStatus) imagesStatus.textContent = 'Nessuna foto caricata.';
		    }

			    async function publishCurrentFormOnline() {
			      try {
			        // Persist token even if mobile doesn't fire "change" reliably.
			        try {
			          const tokenInput = document.getElementById('gh-token');
			          const remember = document.getElementById('gh-remember');
			          if (tokenInput) saveGithubToken(tokenInput.value.trim(), !!remember?.checked);
		        } catch {}

			        // If user selected photos but did not run AI/upload yet, upload now automatically.
			        const selectedFiles = getSelectedImages(10);
			        if (selectedFiles.length && !lastUploadedImages.length) {
			          await ensureImagesUploaded();
			        }
			        syncImageFieldsFromUploads();

		        const product = readProductFromForm();
		        const missing = getFirstMissingFieldId(product);
		        if (missing) {
		          document.getElementById(missing)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
		          throw new Error('Completa i campi obbligatori (usa "Riempi tutti i campi (AI)" dopo aver caricato le foto).');
		        }

		        if (imagesStatus) imagesStatus.textContent = 'Pubblicazione in corso...';
		        setButtonsDisabled(true);

		        let products = loadProducts();
		        const index = products.findIndex(p => p.id === product.id);
		        const saveLabel = index >= 0 ? '✅ Annuncio aggiornato' : '✅ Annuncio aggiunto';
		        if (index >= 0) products[index] = product;
		        else products.push(product);
		        saveProducts(products);

			        const result = await publishProductsToGithub(products);
			        const commitUrl = result && result.commit && result.commit.html_url ? result.commit.html_url : '';
			        showAlert(commitUrl ? `${saveLabel} e pubblicato online! Commit: ${commitUrl}` : `${saveLabel} e pubblicato online!`);
			        if (imagesStatus) imagesStatus.textContent = 'Pubblicazione completata.';

			        resetProductForm();
			        clearSelectedImages();
			      } catch (err) {
			        if (imagesStatus) imagesStatus.textContent = `Pubblicazione fallita: ${err && err.message ? err.message : 'errore sconosciuto'}`;
			        showAlert(err.message || 'Errore pubblicazione.', 'error');
			      } finally {
			        setButtonsDisabled(false);
			      }
			    }

			    document.getElementById('btn-publish-ad')?.addEventListener('click', publishCurrentFormOnline);
			    document.getElementById('btn-publish-ad-inline')?.addEventListener('click', publishCurrentFormOnline);

	    function buildChatgptPrompt() {
	      if (!lastUploadedImages.length) {
	        throw new Error('Carica prima almeno 1 foto (Step 1).');
	      }
	      const parseGalleryCsv = (csv) => String(csv || '')
	        .split(',')
	        .map((s) => s.trim())
	        .filter(Boolean);

	      const currentImage = document.getElementById('image-url')?.value?.trim() || '';
	      const currentGallery = parseGalleryCsv(document.getElementById('gallery-urls')?.value || '');
	      const effectiveGallery = currentGallery.length ? currentGallery : (currentImage ? [currentImage] : []);

	      const today = new Date().toISOString().slice(0, 10);
	      const shippingRaw = parseFloat(document.getElementById('shipping-cost')?.value || '0');
	      const imageUrls = lastUploadedImages.map((u) => u.pagesUrl).filter(Boolean);
	      const rawUrls = lastUploadedImages.map((u) => u.rawUrl).filter(Boolean);
	      const draft = {
	        name: document.getElementById('name')?.value?.trim() || '',
	        section: document.getElementById('section')?.value || 'usato',
	        category: document.getElementById('category')?.value || '',
	        location: document.getElementById('location')?.value?.trim() || '',
	        condition: '',
	        postedAt: today,
	        description: '',
	        price: 0,
	        shippingCost: Number.isFinite(shippingRaw) ? shippingRaw : 0,
	        year: '',
	        dimensions: '',
	        status: 'available',
	        featured: false,
	        image: currentImage || (lastUploadedImages[0]?.rawUrl || lastUploadedImages[0]?.path || ''),
	        gallery: effectiveGallery,
	        stripeLinkBuy: '',
	        paypalBuy: '',
	        whatsappText: ''
	      };
		      return [
		        'Analizza le foto e compila TUTTI i campi per un annuncio su ENS Vintage.',
		        'Rispondi SOLO con JSON valido (nessun testo fuori dal JSON).',
		        'NON includere il campo "id": viene assegnato automaticamente in pubblicazione.',
		        'Se non riesci a vedere le URL, chiedimi di allegare le immagini direttamente in chat.',
	        '',
	        'Bozza JSON (da completare):',
	        JSON.stringify(draft, null, 2),
	        '',
	        'Foto (Pages URL):',
	        ...imageUrls,
	        '',
	        'Foto (Raw URL - alternative):',
	        ...rawUrls
	      ].join('\n');
	    }

	    function stripJsonFromText(text) {
	      const t = String(text || '').trim();
	      if (!t) return '';
	      // Remove common markdown fences if present.
	      const fenceStart = t.indexOf('```');
	      if (fenceStart !== -1) {
	        const firstBrace = t.indexOf('{');
	        const lastBrace = t.lastIndexOf('}');
	        if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
	          return t.slice(firstBrace, lastBrace + 1);
	        }
	      }
	      return t;
	    }

	    function parseGalleryCsv(csv) {
	      return String(csv || '')
	        .split(',')
	        .map((s) => s.trim())
	        .filter(Boolean);
	    }

	    function getEffectiveImageAndGallery() {
	      const image = document.getElementById('image-url')?.value?.trim() || '';
	      const gallery = parseGalleryCsv(document.getElementById('gallery-urls')?.value || '');
	      const effectiveGallery = gallery.length ? gallery : (image ? [image] : []);
	      return { image, gallery: effectiveGallery };
	    }

	    function normalizeCategory(value) {
	      const allowed = new Set([
	        'mobili', 'arte', 'ceramica', 'orologeria', 'oggetti', 'gioielli',
	        'moda', 'elettronica', 'casa', 'sport', 'auto', 'bimbi',
	        'collezionismo', 'libri', 'altro'
	      ]);
	      const raw = String(value || '').trim().toLowerCase();
	      if (allowed.has(raw)) return raw;
	      return '';
	    }

	    function normalizeSection(value, category) {
	      const raw = String(value || '').trim().toLowerCase();
	      if (raw === 'antiquariato' || raw === 'usato') return raw;
	      // Fallback: antique categories default to antiquariato
	      const antique = new Set(['mobili', 'arte', 'ceramica', 'orologeria', 'gioielli', 'oggetti']);
	      if (antique.has(String(category || '').trim().toLowerCase())) return 'antiquariato';
	      return 'usato';
	    }

	    function coercePrice(value) {
	      if (typeof value === 'number' && Number.isFinite(value)) return value;
	      const s = String(value || '').replace(',', '.').replace(/[^0-9.]/g, '');
	      const n = parseFloat(s);
	      return Number.isFinite(n) ? n : 0;
	    }

	    function formatAiErrorMessage(raw) {
	      const msg = String(raw || '').trim();
	      const low = msg.toLowerCase();
	      if (!msg) return 'Errore AI.';
	      if (low.includes('missing openai') || low.includes('openai_api_key')) {
	        return 'AI non configurata: aggiungi il secret OPENAI_API_KEY (oppure OPENAI_KEY/CHATGPT_API_KEY) in GitHub Actions.';
	      }
	      if (low.includes('insufficient_quota') || low.includes('exceeded your current quota') || low.includes('billing')) {
	        return 'AI non disponibile: quota OpenAI esaurita o billing non attivo. Apri platform.openai.com/billing e abilita credito API.';
	      }
	      if (low.includes('rate limit')) {
	        return 'AI temporaneamente occupata (rate limit). Riprova tra 1-2 minuti.';
	      }
	      return msg;
	    }

	    function base64DecodeUnicode(str) {
	      const cleaned = String(str || '').replace(/\n/g, '');
	      try {
	        return decodeURIComponent(escape(atob(cleaned)));
	      } catch {
	        return atob(cleaned);
	      }
	    }

	    function sleep(ms) {
	      return new Promise((resolve) => setTimeout(resolve, ms));
	    }

	    function makeRequestId() {
	      const rand = Math.random().toString(16).slice(2, 8);
	      return `ai-${Date.now()}-${rand}`;
	    }

	    function buildRawUrl({ owner, repo, branch, path }) {
	      const safePath = String(path || '').replace(/^\/+/, '');
	      return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${safePath}`;
	    }

	    async function putJsonFileToGithub({ path, data, message }) {
	      const cfg = loadGithubConfig();
	      const token = loadGithubToken();
	      if (!token) throw new Error('Inserisci il Token GitHub.');
	      const safePath = String(path || '').replace(/^\/+/, '');
	      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${safePath}`;
	      const payload = {
	        message: message || `Aggiorna ${safePath}`,
	        content: base64EncodeUnicode(JSON.stringify(data, null, 2) + '\n'),
	        branch: cfg.branch
	      };
	      return await githubRequest(url, { method: 'PUT', token, body: payload });
	    }

	    async function getJsonFileFromGithub(path) {
	      const cfg = loadGithubConfig();
	      const token = loadGithubToken();
	      if (!token) throw new Error('Inserisci il Token GitHub.');
	      const safePath = String(path || '').replace(/^\/+/, '');
	      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${safePath}?ref=${encodeURIComponent(cfg.branch)}`;
	      try {
	        const res = await githubRequest(url, { token });
	        if (!res || !res.content) return null;
	        const text = base64DecodeUnicode(res.content);
	        return JSON.parse(text);
	      } catch (err) {
	        if (String(err.message || '').includes('404')) return null;
	        throw err;
	      }
	    }

	    async function requestAiDraftOnGithub({ baseDraft, images }) {
	      const cfg = loadGithubConfig();
	      const requestId = makeRequestId();
	      const requestPath = `data/ai-requests/${requestId}.json`;
	      const outputPath = `data/ai-results/${requestId}.json`;

	      const normalizedImages = (Array.isArray(images) ? images : []).slice(0, 10).map((img) => {
	        const path = String(img.path || '').replace(/^\/+/, '');
	        const rawUrl = img.rawUrl || (path ? buildRawUrl({ owner: cfg.owner, repo: cfg.repo, branch: cfg.branch, path }) : '');
	        const pagesUrl = img.pagesUrl || (path ? new URL(path, PUBLIC_SITE_BASE).toString() : '');
	        return { path, rawUrl, pagesUrl };
	      }).filter((img) => img.rawUrl || img.pagesUrl || img.path);

	      const payload = {
	        requestId,
	        createdAt: new Date().toISOString(),
	        outputPath,
	        baseDraft,
	        images: normalizedImages
	      };

	      await putJsonFileToGithub({
	        path: requestPath,
	        data: payload,
	        message: `AI request: ${requestId}`
	      });

	      return { requestId, requestPath, outputPath };
	    }

	    async function triggerAiWorkflowDispatch(requestPath) {
	      const cfg = loadGithubConfig();
	      const token = loadGithubToken();
	      if (!token) return false;
	      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/actions/workflows/ai-autofill.yml/dispatches`;
	      try {
	        await githubRequest(url, {
	          method: 'POST',
	          token,
	          body: {
	            ref: cfg.branch,
	            inputs: { request_file: String(requestPath || '') }
	          }
	        });
	        return true;
	      } catch (err) {
	        console.warn('AI workflow dispatch failed:', err && err.message ? err.message : err);
	        return false;
	      }
	    }

	    async function waitForAiResult(outputPath, { timeoutMs = 240000, intervalMs = 3500 } = {}) {
	      const started = Date.now();
	      while (Date.now() - started < timeoutMs) {
	        const res = await getJsonFileFromGithub(outputPath);
	        if (res) return res;
	        await sleep(intervalMs);
	      }
	      throw new Error('AI: nessun risultato entro 4 minuti. Controlla GitHub Actions > "AI Autofill (Annunci)" e verifica il secret OPENAI_API_KEY (oppure OPENAI_KEY/CHATGPT_API_KEY).');
	    }

	    async function runServerAiAutofill() {
	      if (!lastUploadedImages.length) {
	        throw new Error('Carica prima almeno 1 foto (Step 1).');
	      }

	      // Persist token/config even if mobile doesn't fire "change" reliably.
	      try {
	        const tokenInput = document.getElementById('gh-token');
	        const remember = document.getElementById('gh-remember');
	        if (tokenInput) saveGithubToken(tokenInput.value.trim(), !!remember?.checked);
	      } catch {}

	      const today = new Date().toISOString().slice(0, 10);
	      const shippingRaw = parseFloat(document.getElementById('shipping-cost')?.value || '0');
	      const { image, gallery } = getEffectiveImageAndGallery();

	      const baseDraft = {
	        name: document.getElementById('name')?.value?.trim() || '',
	        section: document.getElementById('section')?.value || 'usato',
	        category: document.getElementById('category')?.value || '',
	        location: document.getElementById('location')?.value?.trim() || '',
	        condition: '',
	        postedAt: today,
	        description: '',
	        price: 0,
	        shippingCost: Number.isFinite(shippingRaw) ? shippingRaw : 0,
	        year: '',
	        dimensions: '',
	        status: 'available',
	        featured: false,
	        image: image || (lastUploadedImages[0]?.rawUrl || lastUploadedImages[0]?.path || ''),
	        gallery: gallery.length ? gallery : [image].filter(Boolean),
	        stripeLinkBuy: '',
	        paypalBuy: '',
	        whatsappText: ''
	      };

	      const { requestId, requestPath, outputPath } = await requestAiDraftOnGithub({
	        baseDraft,
	        images: lastUploadedImages
	      });

	      await triggerAiWorkflowDispatch(requestPath);
	      const res = await waitForAiResult(outputPath);
	      if (res && res.ok === false) {
	        throw new Error(formatAiErrorMessage(res.error || 'Errore AI.'));
	      }

	      const draft = (res && res.draft && typeof res.draft === 'object') ? res.draft : res;
	      if (!draft || typeof draft !== 'object') throw new Error('AI: risposta non valida.');

	      // Normalize again on client (defensive).
	      draft.category = normalizeCategory(draft.category) || baseDraft.category || 'altro';
	      draft.section = normalizeSection(draft.section, draft.category);
		      draft.status = 'available';
		      draft.postedAt = today;
		      draft.price = coercePrice(draft.price);
		      draft.shippingCost = coercePrice(draft.shippingCost != null ? draft.shippingCost : baseDraft.shippingCost);
		      if (draft && Object.prototype.hasOwnProperty.call(draft, 'id')) delete draft.id;
		      draft.image = baseDraft.image;
		      draft.gallery = baseDraft.gallery;

	      const draftEl = document.getElementById('draft-json');
	      if (draftEl) draftEl.value = JSON.stringify(draft, null, 2);
	      applyDraftToForm(draft);
	      return { requestId, outputPath, draft };
	    }

	    document.getElementById('btn-copy-chatgpt-prompt')?.addEventListener('click', async () => {
	      try {
	        const prompt = buildChatgptPrompt();
	        await copyTextToClipboard(prompt);
	        showAlert('Prompt ChatGPT copiato. Incollalo in ChatGPT e allega le foto se richiesto.');
	      } catch (err) {
	        console.error(err);
	        showAlert(err.message || 'Impossibile copiare il prompt.', 'error');
	      }
	    });

	    document.getElementById('btn-share-chatgpt-prompt')?.addEventListener('click', async () => {
	      try {
	        const prompt = buildChatgptPrompt();
	        if (navigator.share) {
	          const files = getSelectedImages(10);
	          const shareData = { title: 'ENS Vintage - Prompt annuncio', text: prompt };
	          // On supported mobile browsers you can share both text + photos to the ChatGPT app.
	          if (files.length && navigator.canShare && navigator.canShare({ files })) {
	            shareData.files = files;
	          }
	          await navigator.share(shareData);
	          showAlert('Prompt condiviso.');
	          return;
	        }
	        await copyTextToClipboard(prompt);
	        showAlert('Condivisione non supportata: prompt copiato.');
	      } catch (err) {
	        console.error(err);
	        showAlert(err.message || 'Impossibile condividere il prompt.', 'error');
	      }
	    });

	    function renderProducts() {
      const products = loadProducts();
      const container = document.getElementById('products-list');
      const count = document.getElementById('product-count');

      count.textContent = products.length;

	      container.innerHTML = products.map(product => `
	        <div class="product-card">
	          <img src="${product.image || 'assets/brand/og-1200x630.jpg'}" alt="${product.name}" onerror="this.src='assets/brand/og-1200x630.jpg'">
          <h3>${product.name}</h3>
          <p><strong>Sezione:</strong> ${product.section || 'antiquariato'}</p>
          <p><strong>Categoria:</strong> ${product.category}</p>
          <p><strong>Prezzo:</strong> €${Number(product.price || 0).toFixed(2)}</p>
          <p><strong>Spedizione:</strong> €${Number(product.shippingCost || 0).toFixed(2)}</p>
          <p><strong>Status:</strong> <span style="color: ${
            product.status === 'available' ? '#4caf50' : 
            product.status === 'reserved' ? '#ff9800' : '#dc3545'
          }">${product.status}</span></p>
          <p><strong>Zona:</strong> ${product.location || 'N/A'}</p>
          <p><strong>Condizione:</strong> ${product.condition || 'N/A'}</p>
          <p><strong>Data:</strong> ${product.postedAt || 'N/A'}</p>
          <p><strong>Periodo:</strong> ${product.year || 'N/A'}</p>
	          <div class="product-actions">
	            <button class="btn-edit" onclick="editProduct(${product.id})">✏️ Modifica</button>
	            <button class="btn-ad" onclick="copyAdText(${product.id})">📋 Copia Annuncio</button>
	            <button class="btn-online" onclick="publishDraftOnline(${product.id})">🚀 Inserisci online</button>
	            <button class="btn-delete" onclick="deleteProduct(${product.id})">🗑️ Elimina</button>
	          </div>
	        </div>
	      `).join('');
	      updatePublishStatus();
    }

    function editProduct(id) {
      const products = loadProducts();
      const product = products.find(p => p.id === id);
      if (!product) return;

      document.getElementById('name').value = product.name;
      document.getElementById('section').value = String(product.section || 'antiquariato');
      document.getElementById('category').value = product.category;
      document.getElementById('location').value = product.location || '';
      document.getElementById('condition').value = product.condition || '';
      document.getElementById('postedAt').value = String(product.postedAt || '').includes('T')
        ? String(product.postedAt).slice(0, 10)
        : (product.postedAt || '');
      document.getElementById('description').value = product.description;
      document.getElementById('price').value = product.price;
      document.getElementById('shipping-cost').value = Number(product.shippingCost || 0);
      document.getElementById('year').value = product.year;
      document.getElementById('dimensions').value = product.dimensions;
      document.getElementById('status').value = product.status;
      document.getElementById('featured').checked = product.featured;
      document.getElementById('stripe-link').value = product.stripeLinkBuy;
      document.getElementById('paypal-link').value = product.paypalBuy;
      document.getElementById('whatsapp-text').value = product.whatsappText;
      document.getElementById('image-url').value = product.image;
      document.getElementById('gallery-urls').value = Array.isArray(product.gallery) ? product.gallery.join(', ') : '';

      // Aggiungi ID nascosto
      let idInput = document.querySelector('input[name="id"]');
      if (!idInput) {
        idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'id';
        document.getElementById('product-form').appendChild(idInput);
      }
      idInput.value = id;

	      document.getElementById('btn-save-product').textContent = 'Aggiorna bozza (solo locale)';
	      window.scrollTo({ top: 0, behavior: 'smooth' });
	    }

	    function deleteProduct(id) {
	      if (!confirm("Sei sicuro di voler eliminare questo annuncio?")) return;

	      let products = loadProducts();
	      products = products.filter(p => p.id !== id);
	      saveProducts(products);
	      showAlert('✅ Annuncio eliminato!');
	    }

	    async function publishDraftOnline(id) {
	      const products = loadProducts();
	      const product = products.find(p => p.id === id);
	      if (!product) {
	        showAlert('Bozza non trovata.', 'error');
	        return;
	      }
	      if (!confirm(`Pubblicare online solo questo annuncio?\n\n${product.name}`)) return;

	      try {
	        const tokenInput = document.getElementById('gh-token');
	        const remember = document.getElementById('gh-remember');
	        if (tokenInput) saveGithubToken(tokenInput.value.trim(), !!remember?.checked);
	      } catch {}

	      try {
	        const liveProducts = await loadLiveProducts();
	        const next = Array.isArray(liveProducts) ? [...liveProducts] : [];
	        const index = next.findIndex(p => p.id === product.id);
	        if (index >= 0) next[index] = product;
	        else next.push(product);

	        const result = await publishProductsToGithub(next);
	        const commitUrl = result && result.commit && result.commit.html_url ? result.commit.html_url : '';
	        showAlert(commitUrl ? `✅ Annuncio pubblicato online. Commit: ${commitUrl}` : '✅ Annuncio pubblicato online.');
	      } catch (err) {
	        showAlert(err.message || 'Errore durante la pubblicazione del singolo annuncio.', 'error');
	      }
	    }

	    // Load products on page load
	    (function initFormDefaults() {
	      const postedAtEl = document.getElementById('postedAt');
	      if (postedAtEl && !postedAtEl.value) postedAtEl.value = new Date().toISOString().slice(0, 10);
	      const shippingEl = document.getElementById('shipping-cost');
	      if (shippingEl && !shippingEl.value) shippingEl.value = '0';
	    })();
	    applyInsertOnlyMode();

	    initializeProductsIfEmpty();
	    renderProducts();
  </script>
</body>
</html>
