<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Carrello — riepilogo articoli e richiesta di preventivo.">
  <meta name="theme-color" content="#f6f1e7">
  <meta property="og:title" content="Carrello — ENS Vintage">
  <meta property="og:description" content="Riepilogo prodotti e richiesta di preventivo personalizzato.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://egly87.github.io/ensantiquarato.github.io/carrello.html">
  <meta property="og:image" content="https://egly87.github.io/ensantiquarato.github.io/assets/brand/og-1200x630.jpg">
  <title>Carrello — ENS Vintage</title>
  <link rel="canonical" href="https://egly87.github.io/ensantiquarato.github.io/carrello.html">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/brand/favicon-512.png" type="image/png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div id="app">
    <header class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-brand">
          <img src="assets/brand/logo.svg" alt="ENS Vintage" class="logo" loading="lazy" width="42" height="42" decoding="async">
          <span>ENS Vintage</span>
        </a>
        <nav class="navbar-menu">
          <a href="index.html" class="nav-link">Home</a>
          <a href="catalogo.html" class="nav-link">Annunci</a>
          <a href="catalogo.html#preferiti=1" class="nav-link">Preferiti</a>
          <a href="chi-siamo.html" class="nav-link">Chi siamo</a>
          <a href="contatti.html" class="nav-link">Contatti</a>
          <a href="carrello.html" class="nav-link nav-link-cart active"><svg class="cart-icon-svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 5h2l2 10h10l2-7H7"/><circle cx="10" cy="19" r="1.5"/><circle cx="17" cy="19" r="1.5"/></svg><span>Carrello</span><span class="cart-count-badge hidden" data-cart-count>0</span></a>
        </nav>
      </div>
    </header>

    <main>
      <section class="container section--tight">
        <span class="hero-kicker">Carrello</span>
        <h1>Riepilogo acquisto</h1>
        <p class="text-muted">Per pezzi unici l'acquisto e' sempre personale: puoi pagare il singolo articolo con Stripe/PayPal oppure richiedere un preventivo per piu pezzi.</p>
      </section>

      <section class="container cart-layout">
        <div>
          <div id="alert-container"></div>
          <div id="cart-items" class="cart-list"></div>
          <p id="empty-message" class="text-muted">Il tuo carrello e' vuoto.</p>
        </div>

        <aside class="cart-summary" id="summary">
          <h3>Riepilogo</h3>
          <div class="summary-row">
            <span>Subtotale</span>
            <span id="subtotal">€0.00</span>
          </div>
          <div class="summary-row">
            <span>Spedizione</span>
            <span id="shipping">€0.00</span>
          </div>
          <div class="summary-row summary-total">
            <span>Totale</span>
            <span id="total">€0.00</span>
          </div>

          <div class="cart-actions">
            <button class="btn btn-primary" id="whatsapp-btn">Richiedi preventivo WhatsApp</button>
            <a class="btn btn-outline" id="email-btn" href="mailto:egli87@yahoo.com">Richiedi via email</a>
          </div>

          <p class="small mt-2">Pagamento sicuro tramite Stripe o PayPal per i singoli articoli disponibili.</p>
        </aside>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h4>ENS</h4>
            <p>Antiquariato e usato: annunci verificati, foto reali e contatto diretto.</p>
          </div>
          <div class="footer-section">
            <h4>Esplora</h4>
            <ul>
              <li><a href="catalogo.html">Annunci</a></li>
              <li><a href="chi-siamo.html">Chi siamo</a></li>
              <li><a href="contatti.html">Contatti</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Supporto</h4>
            <ul>
              <li><a href="termini.html">Termini e condizioni</a></li>
              <li><a href="privacy.html">Privacy</a></li>
              <li><a href="carrello.html">Carrello</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2026 ENS. Tutti i diritti riservati.</p>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const CART_KEY = 'antiquariato_cart';
    const PRODUCTS_KEY = 'antiquariato_products';

    function getCart() {
      const json = localStorage.getItem(CART_KEY);
      return json ? JSON.parse(json) : [];
    }

    function getProducts() {
      const json = localStorage.getItem(PRODUCTS_KEY);
      return json ? JSON.parse(json) : null;
    }

    async function loadProducts() {
      const liveRes = await fetch(`data/products.json?v=${Date.now()}`, { cache: 'no-store' });
      if (liveRes.ok) {
        const data = await liveRes.json();
        if (Array.isArray(data)) return data;
      }

      const stored = getProducts();
      if (stored && Array.isArray(stored)) return stored;
      throw new Error('Errore caricamento prodotti');
    }

    function getCartCount() {
      return getCart().reduce((sum, item) => sum + Math.max(0, Number(item && item.quantity ? item.quantity : 0)), 0);
    }

    function updateCartBadge() {
      const count = getCartCount();
      document.querySelectorAll('[data-cart-count]').forEach((el) => {
        if (count > 0) {
          el.textContent = String(count);
          el.classList.remove('hidden');
        } else {
          el.textContent = '0';
          el.classList.add('hidden');
        }
      });
    }

    function getProductImage(product) {
      if (!product || typeof product !== 'object') return 'assets/brand/og-1200x630.jpg';
      const main = String(product.image || '').trim();
      if (main) return main;
      if (Array.isArray(product.gallery) && product.gallery.length) {
        const first = String(product.gallery[0] || '').trim();
        if (first) return first;
      }
      return 'assets/brand/og-1200x630.jpg';
    }

    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      updateCartBadge();
      renderCart();
    }

    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alert);
      if (type === 'success') {
        setTimeout(() => alert.remove(), 4000);
      }
    }

    function updateTotals(products) {
      const cart = getCart();
      let subtotal = 0;
      cart.forEach(item => {
        const product = products.find(p => p.id === item.productId);
        if (product) subtotal += product.price * item.quantity;
      });

      const shipping = subtotal > 0 ? 10 : 0;
      const total = subtotal + shipping;

      document.getElementById('subtotal').textContent = `€${subtotal.toFixed(2)}`;
      document.getElementById('shipping').textContent = `€${shipping.toFixed(2)}`;
      document.getElementById('total').textContent = `€${total.toFixed(2)}`;
      return { subtotal, shipping, total };
    }

    function getStatusText(status) {
      const map = { available: 'Disponibile', reserved: 'Riservato', sold: 'Venduto' };
      return map[status] || status;
    }

    function renderItemActions(product) {
      const links = [
        `<a href="prodotto.html?id=${product.id}">Apri annuncio</a>`
      ];
      if (product.stripeLinkBuy) {
        links.push(`<a href="${product.stripeLinkBuy}" target="_blank" rel="noopener">Paga con Stripe</a>`);
      }
      if (product.paypalBuy) {
        links.push(`<a href="${product.paypalBuy}" target="_blank" rel="noopener">Paga con PayPal</a>`);
      }
      if (!product.stripeLinkBuy && !product.paypalBuy) {
        links.push(`<a href="https://wa.me/393296627575?text=${encodeURIComponent(`Ciao, vorrei acquistare: ${product.name}`)}" target="_blank" rel="noopener">Acquista su WhatsApp</a>`);
      }
      return `<div class="payment-links">${links.join('')}</div>`;
    }

    async function renderCart() {
      const cart = getCart();
      updateCartBadge();
      let products = [];
      try {
        products = await loadProducts();
      } catch (e) {
        console.error(e);
        showAlert('Impossibile caricare i prodotti. Riprova piu tardi.', 'error');
        return;
      }
      const container = document.getElementById('cart-items');
      const emptyMessage = document.getElementById('empty-message');
      const summary = document.getElementById('summary');

      if (cart.length === 0) {
        container.innerHTML = '';
        emptyMessage.style.display = 'block';
        summary.style.display = 'none';
        return;
      }

      emptyMessage.style.display = 'none';
      summary.style.display = 'block';

      container.innerHTML = cart.map(item => {
        const product = products.find(p => p.id === item.productId);
        if (!product) return '';
        const imageSrc = getProductImage(product);
        return `
          <div class="cart-item">
            <img src="${imageSrc}" alt="${product.name}" onerror="this.src='assets/brand/og-1200x630.jpg'">
            <div>
              <h4>${product.name}</h4>
              <div class="cart-item-meta">
                <span>${product.year || ''}</span>
                <span>${product.dimensions || ''}</span>
                <span>${getStatusText(product.status)}</span>
              </div>
              <div class="product-price">€ ${product.price.toFixed(2)}</div>
              <div class="quantity-control">
                <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.quantity - 1})">−</button>
                <span style="min-width: 32px; text-align: center;">${item.quantity}</span>
                <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.quantity + 1})">+</button>
                <button class="remove-btn" onclick="removeFromCart(${item.productId})">Rimuovi</button>
              </div>
              ${renderItemActions(product)}
            </div>
          </div>
        `;
      }).join('');

      updateTotals(products);
      updateContactLinks(products);
    }

    function updateQuantity(productId, quantity) {
      const cart = getCart();
      if (quantity <= 0) {
        removeFromCart(productId);
        return;
      }
      const item = cart.find(i => i.productId === productId);
      if (item) {
        item.quantity = quantity;
        saveCart(cart);
      }
    }

    function removeFromCart(productId) {
      const cart = getCart();
      const filtered = cart.filter(i => i.productId !== productId);
      saveCart(filtered);
    }

    function updateContactLinks(products) {
      const cart = getCart();
      const lines = cart.map(item => {
        const product = products.find(p => p.id === item.productId);
        if (!product) return '';
        return `- ${product.name} x${item.quantity}`;
      }).filter(Boolean);

      const message = `Ciao! Vorrei un preventivo per i seguenti pezzi:\n${lines.join('\n')}`;
      const whatsappNumber = '393296627575';
      const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
      document.getElementById('whatsapp-btn').onclick = () => window.open(whatsappUrl, '_blank');

      const emailBody = encodeURIComponent(message);
      const emailBtn = document.getElementById('email-btn');
      emailBtn.href = `mailto:egli87@yahoo.com?subject=Richiesta%20preventivo&body=${emailBody}`;
    }

    window.addEventListener('storage', (e) => {
      if (e.key === CART_KEY) {
        updateCartBadge();
        renderCart();
      }
    });

    updateCartBadge();
    renderCart();
  </script>
</body>
</html>
